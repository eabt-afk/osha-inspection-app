<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OSHA Self-Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      color: #222;
      padding: 0.75rem;
    }

    .app-shell {
      max-width: 650px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 92vh;
    }

    header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
    }

    header h1 { font-size: 1rem; font-weight: 600; }
    header small { font-size: 0.75rem; color: #666; }

    .filters {
      display: flex;
      overflow-x: auto;
      padding: 0.5rem 1rem;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .filter-chip {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      white-space: nowrap;
    }

    .filter-chip.active {
      background: #0070f3;
      color: #fff;
      border-color: #0070f3;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem;
    }

    .category-group { margin-bottom: 0.75rem; }

    .category-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
    }

    .issue-row {
      background: #fafafa;
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 0.5rem;
    }

    .issue-text { font-size: 0.85rem; flex: 1; }
    .issue-status-icon { font-size: 1.1rem; width: 2rem; text-align: right; }

    .status-compliant { color: #16a34a; }
    .status-needs_attention { color: #dc2626; }
    .status-na { color: #6b7280; }

    /* Inspector bar at bottom */
    .inspector-bar {
      border-top: 1px solid #eee;
      padding: 0.6rem 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      background: #fafafa;
    }

    .inspector-fields {
      flex: 1;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .inspector-fields input,
    .inspector-fields select {
      flex: 1;
      min-width: 120px;
      font-size: 0.8rem;
      padding: 0.35rem 0.45rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .inspector-fields select {
      min-width: 160px;
    }

    #submitBtn {
      font-size: 0.8rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    #submitBtn:disabled {
      opacity: 0.7;
      cursor: default;
    }

    /* Detail modal */
    .detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 10;
    }

    .detail-backdrop.open { display: flex; }

    .detail-panel {
      background: #fff;
      width: 100%;
      max-width: 600px;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
      padding: 1rem;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: flex-start;
    }

    .detail-title { font-size: 0.95rem; font-weight: 600; }
    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      white-space: nowrap;
    }

    .detail-full-issue {
      font-size: 0.85rem;
      background: #f9fafb;
      padding: 0.5rem;
      border-radius: 8px;
      line-height: 1.35;
    }

    .status-label,
    .photo-label,
    .comment-label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-buttons {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
      flex-wrap: wrap;
    }

    .status-btn {
      flex: 1;
      min-width: 115px;
      border-radius: 999px;
      padding: 0.35rem;
      font-size: 0.8rem;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .status-btn.active {
      border-color: #0070f3;
      background: #e0f2fe;
      color: #0369a1;
    }

    .photo-group input[type="file"] {
      margin-top: 0.25rem;
      font-size: 0.8rem;
    }

    .photo-preview-container {
      margin-top: 0.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .photo-thumb {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    textarea#commentInput {
      width: 100%;
      min-height: 60px;
      font-size: 0.8rem;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      resize: vertical;
    }

    .detail-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-secondary { background: #e5e7eb; border: none; }
    .btn-primary { background: #0070f3; color: #fff; border: none; }
  </style>
</head>

<body>
<div class="app-shell">

  <header>
    <h1>OSHA Self-Inspection</h1>
    <small>Tap an item to update status, add photos & notes</small>
  </header>

  <div class="filters" id="filters"></div>

  <div class="list" id="issueList"></div>

  <!-- Inspector info + submit at bottom -->
  <div class="inspector-bar">
    <div class="inspector-fields">
      <input id="inspectorName" type="text" placeholder="Inspector name" />
      <input id="inspectorEmail" type="email" placeholder="Email" />
      <select id="areaSelect" aria-label="Area">
        <option value="">Loading areas…</option>
      </select>
    </div>
    <button id="submitBtn">Submit</button>
  </div>

</div>

<!-- Detail modal -->
<div class="detail-backdrop" id="detailBackdrop">
  <div class="detail-panel">

    <div class="detail-header">
      <div class="detail-title" id="detailShortIssue"></div>
      <span class="badge" id="detailCategory"></span>
    </div>

    <div class="detail-full-issue" id="detailFullIssue"></div>

    <div>
      <div class="status-label">Status</div>
      <div class="status-buttons">
        <button class="status-btn" data-status="compliant" id="btnCompliant">✔ Compliant</button>
        <button class="status-btn" data-status="needs_attention" id="btnNeedsAttention">❌ Needs Attention</button>
        <button class="status-btn" data-status="na" id="btnNA">➖ N/A</button>
      </div>
    </div>

    <div class="photo-group">
      <div class="photo-label">Photos (optional)</div>
      <input type="file" id="photoInput" accept="image/*" multiple />
      <div id="photoPreviewContainer" class="photo-preview-container"></div>
    </div>

    <div class="comment-group">
      <div class="comment-label">Comments / Notes (optional)</div>
      <textarea id="commentInput" placeholder="Add any additional context, observations, or follow-up needed..."></textarea>
    </div>

    <div class="detail-actions">
      <button class="btn btn-secondary" id="btnCancel">Cancel</button>
      <button class="btn btn-primary" id="btnSave">Save</button>
    </div>

  </div>
</div>

<script>
/**
 * CONFIG
 */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbznXNi6HRD8qpn3whwdxsj9X0dq7xdii-Gn7pPqzsNvnGoJQ1G5ephp1yhUlnqd-qW1/exec";
const STORAGE_KEY = "osha_inspection_app_v3_sheet_driven";

/**
 * DOM
 */
const filtersContainer = document.getElementById("filters");
const issueListEl = document.getElementById("issueList");

const detailBackdrop = document.getElementById("detailBackdrop");
const detailShortIssue = document.getElementById("detailShortIssue");
const detailCategory = document.getElementById("detailCategory");
const detailFullIssue = document.getElementById("detailFullIssue");

const btnCompliant = document.getElementById("btnCompliant");
const btnNeedsAttention = document.getElementById("btnNeedsAttention");
const btnNA = document.getElementById("btnNA");

const photoInput = document.getElementById("photoInput");
const photoPreviewContainer = document.getElementById("photoPreviewContainer");
const commentInput = document.getElementById("commentInput");
const btnCancel = document.getElementById("btnCancel");
const btnSave = document.getElementById("btnSave");

const inspectorNameInput = document.getElementById("inspectorName");
const inspectorEmailInput = document.getElementById("inspectorEmail");
const areaSelect = document.getElementById("areaSelect");
const submitBtn = document.getElementById("submitBtn");

/**
 * STATE
 */
let QUESTION_BANK = [];
let AREAS = [];
let issues = [];
let currentFilter = "All";
let currentIssueId = null;

let tempStatus = null;
let tempPhotos = [];
let tempComments = "";

/**
 * HELPERS
 */
function safeTrim(v) { return String(v ?? "").trim(); }
function isTrue(v) { return String(v ?? "").toUpperCase() === "TRUE"; }

function statusToSymbol(s) {
  if (s === "compliant") return "✔";
  if (s === "needs_attention") return "✖";
  if (s === "na") return "➖";
  return "•";
}
function statusToClass(s) {
  if (s === "compliant") return "status-compliant";
  if (s === "needs_attention") return "status-needs_attention";
  if (s === "na") return "status-na";
  return "";
}

function apiGet(action) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + action + "_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");

    window[cb] = (data) => {
      try {
        delete window[cb];
        script.remove();
        if (!data || data.result !== "success") return reject(new Error(`API ${action} failed`));
        resolve(data.rows || []);
      } catch (err) {
        reject(err);
      }
    };

    script.onerror = () => {
      delete window[cb];
      script.remove();
      reject(new Error(`Failed to load API ${action}`));
    };

    script.src = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&callback=${encodeURIComponent(cb)}`;
    document.body.appendChild(script);
  });
}

/**
 * SHEET-DRIVEN LOADING
 */
function normalizeQuestionRow(row) {
  // Expecting headers from Question_Bank:
  // ID, Category, ShortIssue, FullIssue, Area_Tags, Active, Requires_Photo, Requires_Comment, Followup_Group, Order
  const id = safeTrim(row.ID);
  return {
    id: Number(id),
    category: safeTrim(row.Category),
    shortIssue: safeTrim(row.ShortIssue),
    fullIssue: safeTrim(row.FullIssue),
    active: isTrue(row.Active),
    order: Number(row.Order || 9999),
    // we store these for future enhancements; not enforced yet
    requiresPhoto: isTrue(row.Requires_Photo),
    requiresComment: isTrue(row.Requires_Comment),
    areaTags: safeTrim(row.Area_Tags || "ALL"),
    followupGroup: safeTrim(row.Followup_Group || "")
  };
}

function loadSavedMap() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return new Map();
  try {
    const parsed = JSON.parse(saved);
    return new Map(parsed.map(x => [Number(x.id), x]));
  } catch {
    return new Map();
  }
}

function saveIssues() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(issues));
}

function applyAreaFilterToQuestions(qs, selectedArea) {
  // For now we keep it simple: show ALL, or show those tagged with selected area (if you start using tags)
  // If Area_Tags is blank, treat as ALL.
  const areaId = safeTrim(selectedArea || "ALL");
  return qs.filter(q => {
    const tags = safeTrim(q.areaTags || "ALL").split(",").map(t => t.trim());
    return tags.includes("ALL") || tags.includes(areaId);
  });
}

function rebuildIssuesFromSheet() {
  const savedMap = loadSavedMap();
  const selectedArea = areaSelect.value || "ALL";

  const activeQs = applyAreaFilterToQuestions(
    QUESTION_BANK.filter(q => q.active),
    selectedArea
  ).sort((a,b) => a.order - b.order);

  issues = activeQs.map(q => {
    const prior = savedMap.get(q.id);
    return {
      id: q.id,
      category: q.category,
      shortIssue: q.shortIssue,
      fullIssue: q.fullIssue,
      status: prior?.status ?? null,
      photos: Array.isArray(prior?.photos) ? prior.photos : [],
      comments: prior?.comments ?? ""
    };
  });

  saveIssues();
  currentFilter = "All";
  renderFilters();
  renderIssueList();
}

async function loadConfig() {
  // Areas
  AREAS = await apiGet("areas");
  const activeAreas = AREAS
    .filter(a => String(a.Active ?? a.active ?? "").toUpperCase() === "TRUE")
    .sort((a,b) => Number(a.Order || 9999) - Number(b.Order || 9999));

  areaSelect.innerHTML = activeAreas.map(a => {
    const id = safeTrim(a.Area_ID || a.area_id || "");
    const name = safeTrim(a.Area_Name || a.area_name || id);
    return `<option value="${id}">${name}</option>`;
  }).join("");

  // Default to ALL if present
  const hasAll = activeAreas.some(a => safeTrim(a.Area_ID || "") === "ALL");
  areaSelect.value = hasAll ? "ALL" : (activeAreas[0] ? safeTrim(activeAreas[0].Area_ID) : "ALL");

  areaSelect.addEventListener("change", () => {
    // On area change we rebuild (keeps saved statuses where IDs overlap)
    rebuildIssuesFromSheet();
  });

  // Questions
  const qbRows = await apiGet("questions");
  QUESTION_BANK = qbRows.map(normalizeQuestionRow);

  rebuildIssuesFromSheet();
}

/**
 * FILTER CHIPS
 */
function getCategories() {
  return ["All", ...new Set(issues.map(i => i.category))];
}
function renderFilters() {
  filtersContainer.innerHTML = "";
  getCategories().forEach(cat => {
    const chip = document.createElement("button");
    chip.className = "filter-chip" + (cat === currentFilter ? " active" : "");
    chip.textContent = cat;
    chip.onclick = () => { currentFilter = cat; renderFilters(); renderIssueList(); };
    filtersContainer.appendChild(chip);
  });
}

/**
 * LIST RENDERING
 */
function renderIssueList() {
  issueListEl.innerHTML = "";
  const filtered = currentFilter === "All"
    ? issues
    : issues.filter(i => i.category === currentFilter);

  const grouped = {};
  filtered.forEach(i => { (grouped[i.category] ||= []).push(i); });

  Object.keys(grouped).forEach(cat => {
    const group = document.createElement("div");
    group.className = "category-group";

    const title = document.createElement("div");
    title.className = "category-title";
    title.textContent = cat;
    group.appendChild(title);

    grouped[cat].forEach(issue => {
      const row = document.createElement("div");
      row.className = "issue-row";
      row.onclick = () => openDetail(issue.id);
      row.innerHTML = `
        <div class="issue-text">${issue.shortIssue}</div>
        <div class="issue-status-icon ${statusToClass(issue.status)}">
          ${statusToSymbol(issue.status)}
        </div>
      `;
      group.appendChild(row);
    });

    issueListEl.appendChild(group);
  });
}

/**
 * DETAIL MODAL
 */
function setStatusButtons(s) {
  [btnCompliant, btnNeedsAttention, btnNA].forEach(b => b.classList.remove("active"));
  if (s === "compliant") btnCompliant.classList.add("active");
  if (s === "needs_attention") btnNeedsAttention.classList.add("active");
  if (s === "na") btnNA.classList.add("active");
}
function renderPhotoPreviews() {
  photoPreviewContainer.innerHTML = "";
  tempPhotos.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.className = "photo-thumb";
    photoPreviewContainer.appendChild(img);
  });
}

function openDetail(id) {
  currentIssueId = id;
  const issue = issues.find(i => i.id === id);
  if (!issue) return;

  detailShortIssue.textContent = issue.shortIssue;
  detailCategory.textContent = issue.category;
  detailFullIssue.textContent = issue.fullIssue;

  tempStatus = issue.status;
  tempPhotos = Array.isArray(issue.photos) ? [...issue.photos] : [];
  tempComments = issue.comments || "";

  commentInput.value = tempComments;
  setStatusButtons(tempStatus);
  renderPhotoPreviews();

  photoInput.value = "";
  detailBackdrop.classList.add("open");
}
function closeDetail() {
  detailBackdrop.classList.remove("open");
  currentIssueId = null;
}

btnCancel.onclick = closeDetail;

btnCompliant.onclick = () => { tempStatus = "compliant"; setStatusButtons(tempStatus); };
btnNeedsAttention.onclick = () => { tempStatus = "needs_attention"; setStatusButtons(tempStatus); };
btnNA.onclick = () => { tempStatus = "na"; setStatusButtons(tempStatus); };

photoInput.onchange = e => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = evt => {
      tempPhotos.push(evt.target.result);
      renderPhotoPreviews();
    };
    reader.readAsDataURL(file);
  });
};

commentInput.oninput = e => {
  tempComments = e.target.value;
};

btnSave.onclick = () => {
  const idx = issues.findIndex(i => i.id === currentIssueId);
  if (idx === -1) return;

  issues[idx].status = tempStatus;
  issues[idx].photos = tempPhotos;
  issues[idx].comments = tempComments;

  saveIssues();
  renderIssueList();
  closeDetail();
};

detailBackdrop.onclick = e => {
  if (e.target === detailBackdrop) closeDetail();
};

/**
 * SUBMIT TO GOOGLE SHEET
 */
async function submitInspection() {
  const name = inspectorNameInput.value.trim();
  const email = inspectorEmailInput.value.trim();
  const areaId = (areaSelect.value || "").trim();

  if (!name || !email) {
    alert("Please enter your name and email before submitting.");
    return;
  }
  if (!areaId) {
    alert("Please select an area before submitting.");
    return;
  }

  const itemsToSend = issues.filter(i => i.status);
  if (!itemsToSend.length) {
    alert("No items have a status yet.");
    return;
  }

  // Send only fields the backend expects
  const payload = {
    inspectorName: name,
    inspectorEmail: email,
    areaId: areaId, // ✅ NEW
    items: itemsToSend.map(i => ({
      id: i.id,
      category: i.category,
      shortIssue: i.shortIssue,
      fullIssue: i.fullIssue,
      status: i.status,
      photos: i.photos || [],
      comments: i.comments || ""
    }))
  };

  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    console.log("Script raw response:", text);

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error("Could not parse Apps Script response as JSON");
    }

    if (!res.ok || !data || data.result !== "success") {
      throw new Error(
        "Apps Script error: " +
        (data && data.message ? data.message : "Unknown") +
        " (status " + res.status + ")"
      );
    }

    alert("Inspection submitted! Starting a new blank inspection...");

    // Reset issues
    issues.forEach(i => {
      i.status = null;
      i.photos = [];
      i.comments = "";
    });

    // Reset inspector fields (keep area selected by default; comment out if you want it cleared)
    inspectorNameInput.value = "";
    inspectorEmailInput.value = "";
    // areaSelect.value = "ALL";

    saveIssues();
    currentFilter = "All";
    renderFilters();
    renderIssueList();

  } catch (err) {
    console.error("Submission failed:", err);
    alert("Error submitting inspection. See console for details.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
  }
}
submitBtn.onclick = submitInspection;

/**
 * INIT
 */
loadConfig().catch(err => {
  console.error(err);
  alert("Failed to load checklist from Google Sheet. Check console for details.");
});
</script>
</body>
</html>
