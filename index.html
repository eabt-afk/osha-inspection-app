<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OSHA Self-Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      color: #222;
      padding: 0.75rem;
    }

    .app-shell {
      max-width: 650px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 92vh;
    }

    header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
    }

    header h1 { font-size: 1rem; font-weight: 600; }
    header small { font-size: 0.75rem; color: #666; }

    .filters {
      display: flex;
      overflow-x: auto;
      padding: 0.5rem 1rem;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .filter-chip {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      white-space: nowrap;
    }

    .filter-chip.active {
      background: #0070f3;
      color: #fff;
      border-color: #0070f3;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem;
    }

    .category-group { margin-bottom: 0.75rem; }

    .category-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
    }

    .issue-row {
      background: #fafafa;
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .issue-text { font-size: 0.85rem; flex: 1; }
    .issue-status-icon { font-size: 1.1rem; width: 2rem; text-align: right; }

    .status-compliant { color: #16a34a; }
    .status-needs_attention { color: #dc2626; }
    .status-na { color: #6b7280; }

    /* Inspector bar at bottom */
    .inspector-bar {
      border-top: 1px solid #eee;
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      background: #fafafa;
    }

    .inspector-fields {
      flex: 1;
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .inspector-fields input {
      flex: 1;
      min-width: 120px;
      font-size: 0.8rem;
      padding: 0.3rem 0.4rem;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    #submitBtn {
      font-size: 0.8rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    #submitBtn:disabled {
      opacity: 0.7;
      cursor: default;
    }

    /* Detail modal */
    .detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 10;
    }

    .detail-backdrop.open { display: flex; }

    .detail-panel {
      background: #fff;
      width: 100%;
      max-width: 600px;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
      padding: 1rem;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .detail-title { font-size: 0.95rem; font-weight: 600; }
    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      white-space: nowrap;
    }

    .detail-full-issue {
      font-size: 0.85rem;
      background: #f9fafb;
      padding: 0.5rem;
      border-radius: 8px;
    }

    .status-label,
    .photo-label,
    .comment-label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-buttons {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .status-btn {
      flex: 1;
      border-radius: 999px;
      padding: 0.35rem;
      font-size: 0.8rem;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .status-btn.active {
      border-color: #0070f3;
      background: #e0f2fe;
      color: #0369a1;
    }

    .photo-group input[type="file"] {
      margin-top: 0.25rem;
      font-size: 0.8rem;
    }

    .photo-preview-container {
      margin-top: 0.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .photo-thumb {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    textarea#commentInput {
      width: 100%;
      min-height: 60px;
      font-size: 0.8rem;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      resize: vertical;
    }

    .detail-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-secondary { background: #e5e7eb; border: none; }
    .btn-primary { background: #0070f3; color: #fff; border: none; }
  </style>
</head>

<body>
<div class="app-shell">

  <header>
    <h1>OSHA Self-Inspection</h1>
    <small>Tap an item to update status, add photos & notes</small>
  </header>

  <div class="filters" id="filters"></div>

  <div class="list" id="issueList"></div>

  <!-- Inspector info + submit at bottom -->
  <div class="inspector-bar">
    <div class="inspector-fields">
      <input id="inspectorName" type="text" placeholder="Inspector name" />
      <input id="inspectorEmail" type="email" placeholder="Email" />
    </div>
    <button id="submitBtn">Submit</button>
  </div>

</div>

<!-- Detail modal -->
<div class="detail-backdrop" id="detailBackdrop">
  <div class="detail-panel">

    <div class="detail-header">
      <div class="detail-title" id="detailShortIssue"></div>
      <span class="badge" id="detailCategory"></span>
    </div>

    <div class="detail-full-issue" id="detailFullIssue"></div>

    <div>
      <div class="status-label">Status</div>
      <div class="status-buttons">
        <button class="status-btn" data-status="compliant" id="btnCompliant">✔ Compliant</button>
        <button class="status-btn" data-status="needs_attention" id="btnNeedsAttention">❌ Needs Attention</button>
        <button class="status-btn" data-status="na" id="btnNA">➖ N/A</button>
      </div>
    </div>

    <div class="photo-group">
      <div class="photo-label">Photos (optional)</div>
      <input type="file" id="photoInput" accept="image/*" multiple />
      <div id="photoPreviewContainer" class="photo-preview-container"></div>
    </div>

    <div class="comment-group">
      <div class="comment-label">Comments / Notes (optional)</div>
      <textarea id="commentInput" placeholder="Add any additional context, observations, or follow-up needed..."></textarea>
    </div>

    <div class="detail-actions">
      <button class="btn btn-secondary" id="btnCancel">Cancel</button>
      <button class="btn btn-primary" id="btnSave">Save</button>
    </div>

  </div>
</div>

<script>
/* 1) RAW DATA (from your JSON) */
const rawIssues = [
  {"ID":"1","Category":"Housekeeping","Short Issue":"Adequate workspace around electrical equipment","Issue":"Is sufficient access and working space provided and maintained about all electrical equipment to permit ready and safe operations and maintenance (36”)? 29 CFR 1910.303"},
  {"ID":"2","Category":"EAP","Short Issue":"Clear exit signs, lighting, and routes","Issue":"Are exits clearly marked “EXIT” and exit routes adequately lit? Access/egress routes are clear and unobstructed? 29 CFR 1910.37"},
  {"ID":"3","Category":"EAP","Short Issue":"Accessible and inspected fire extinguishers","Issue":"Appropriate fire extinguishers are readily accessible; noted in good condition; tagged; and inspected (annual, monthly)? 29 CFR 1910.157"},
  {"ID":"4","Category":"Fire Protection","Short Issue":"Gas cylinders stored securely, capped","Issue":"Cylinders are stored properly (e.g. upright position, caps in place, protected from falling)? 29 CFR 1910.253"},
  {"ID":"5","Category":"Fire Protection","Short Issue":"Flammable liquids within allowed quantities","Issue":"The incidental use of flammable and combustibles is properly stored? [ • 25 gallons of Class IA in containers; • 120 gallons of Class IB, IC, II, or III in containers; • 660 gallons of Class IB, IC, II, or III in a single portable tank ] 29 CFR 1910.106"},
  {"ID":"6","Category":"Fire Protection","Short Issue":"Torch flashback arrestors installed","Issue":"Flashback arrestors are used on burning torches to prevent flashback into the compressed gas tanks? 29 CFR 1910.253"},
  {"ID":"8","Category":"LOTO","Short Issue":"Bench grinders properly guarded","Issue":"Are bench grinders guarded and compliant with OSHA standards [ work rest - 1/8-inch; adjustable tongue guard - 1/4-inch ]? 29 CFR 1910.215"},
  {"ID":"9","Category":"LOTO","Short Issue":"Lockout/tagout performed correctly","Issue":"LO/TO is performed correctly / using correct LO/TO equipment? 29 CFR 1910.147"},
  {"ID":"10","Category":"LOTO","Short Issue":"Written procedures and inspections for LO/TO","Issue":"There is a LO/TO program that includes a written program, machine-specific procedures, and periodic inspections? 29 CFR 1910.147"},
  {"ID":"11","Category":"PPE","Short Issue":"PPE hazard assessment completed","Issue":"A PPE hazard assessment has been completed to determine if hazards are present, or are likely to be present, which necessitate the use of PPE? 29 CFR 1910.132"},
  {"ID":"12","Category":"Hazard Communication","Short Issue":"Proper chemical container labeling","Issue":"Containers of hazardous chemicals in the workplace are labeled, tagged, or marked identifying the chemical it contains as well as the appropriate hazard warnings? 29 CFR 1910.1200"},
  {"ID":"13","Category":"Hazard Communication","Short Issue":"SDS available for all chemicals","Issue":"Safety Data Sheets (SDSs) are in place for materials/chemicals on-site and are readily accessible to all employees? 29 CFR 1910.1200"},
  {"ID":"14","Category":"Hazard Communication","Short Issue":"Employees trained on HazCom/GHS","Issue":"Employees have been trained on Hazard Communication /Globally Harmonized System (GHS)? 29 CFR 1910.1200"},
  {"ID":"15","Category":"Electrical","Short Issue":"Flexible cords in good condition","Issue":"Flexible cords and cables appeared in good condition (ground pin in place, free of splices, insulation)? 29 CFR 1910.305"},
  {"ID":"16","Category":"Electrical","Short Issue":"Proper use of temporary wiring","Issue":"Temporary wiring is only used for construction, remodeling, maintenance, repair, or demolition of buildings, structures, or equipment, and similar activities? 29 CFR 1910.305"},
  {"ID":"17","Category":"Walking-Working Surfaces/Fall Protection","Short Issue":"Fall protection for heights over 4 feet","Issue":"Personnel are protected (guardrails, personal fall arrest equipment) from any fall hazards over 4 feet? 29 CFR 1910.23"},
  {"ID":"18","Category":"Walking-Working Surfaces/Fall Protection","Short Issue":"Self-closing gates at ladder openings","Issue":"Self-closing gates are used at fixed ladder opening and other similar openings? 29 CFR 1910.28"},
  {"ID":"19","Category":"Material Handling / Powered Industrial Trucks (Forklifts)","Short Issue":"Forklifts operated safely","Issue":"Powered industrial truck(s) were operated in a safe manner (i.e. seat belt, safe speed, clear view, etc.) at time of evaluation? 29 CFR 1910.178"},
  {"ID":"20","Category":"Material Handling / Powered Industrial Trucks (Forklifts)","Short Issue":"Wheel chocks used when unloading","Issue":"Wheel chocks are available and/or in use to prevent the trucks from rolling while they are boarded with powered industrial trucks? 29 CFR 1910.178"},
  {"ID":"21","Category":"Mobile Elevated Work Platforms (MEWPs): Scissor Lift / Boom (Aerial) Lift","Short Issue":"Annual MEWP inspection within timeframe","Issue":"An annual inspection is performed no later than thirteen (13) months from the date of the prior annual inspection? ANSI A92.22"},
  {"ID":"22","Category":"Mobile Elevated Work Platforms (MEWPs): Scissor Lift / Boom (Aerial) Lift","Short Issue":"Safe operation of MEWPs","Issue":"MEWPs were operated in a safe manner (i.e. fall protection, on floor of basket, safe path of travel, proper clearances, etc.) at time of evaluation?"},
  {"ID":"23","Category":"Mobile Elevated Work Platforms (MEWPs): Scissor Lift / Boom (Aerial) Lift","Short Issue":"Proper training on MEWPs","Issue":"Have all authorized operators and occupants been properly trained? 29 CFR 1926.454"},
  {"ID":"24","Category":"Tools & Equipment","Short Issue":"Hand tools in safe condition","Issue":"Hand tools appear to be in safe condition with guards in place? 29 CFR 1910.242"}
];

/* 2) Normalize data shape */
const initialIssues = rawIssues.map(r => ({
  id: Number(r.ID),
  category: r.Category,
  shortIssue: r["Short Issue"],
  fullIssue: r.Issue,
  status: null,
  photos: [],      // array of base64 image data
  comments: ""     // text field
}));

/* 3) Storage + state */
const STORAGE_KEY = "osha_inspection_app_v2";

function loadIssues() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return initialIssues;
  try {
    const parsed = JSON.parse(saved);
    return initialIssues.map(base => parsed.find(p => p.id === base.id) || base);
  } catch {
    return initialIssues;
  }
}
function saveIssues() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(issues));
}

let issues = loadIssues();
let currentFilter = "All";
let currentIssueId = null;

/* 4) Filters */
const filtersContainer = document.getElementById("filters");
function getCategories() {
  return ["All", ...new Set(issues.map(i => i.category))];
}
function renderFilters() {
  filtersContainer.innerHTML = "";
  getCategories().forEach(cat => {
    const chip = document.createElement("button");
    chip.className = "filter-chip" + (cat === currentFilter ? " active" : "");
    chip.textContent = cat;
    chip.onclick = () => { currentFilter = cat; renderFilters(); renderIssueList(); };
    filtersContainer.appendChild(chip);
  });
}

/* 5) List rendering */
const issueListEl = document.getElementById("issueList");
function statusToSymbol(s) {
  if (s === "compliant") return "✔";
  if (s === "needs_attention") return "✖";
  if (s === "na") return "➖";
  return "•";
}
function statusToClass(s) {
  if (s === "compliant") return "status-compliant";
  if (s === "needs_attention") return "status-needs_attention";
  if (s === "na") return "status-na";
  return "";
}
function renderIssueList() {
  issueListEl.innerHTML = "";
  const filtered = currentFilter === "All"
    ? issues
    : issues.filter(i => i.category === currentFilter);

  const grouped = {};
  filtered.forEach(i => { (grouped[i.category] ||= []).push(i); });

  Object.keys(grouped).forEach(cat => {
    const group = document.createElement("div");
    group.className = "category-group";

    const title = document.createElement("div");
    title.className = "category-title";
    title.textContent = cat;
    group.appendChild(title);

    grouped[cat].forEach(issue => {
      const row = document.createElement("div");
      row.className = "issue-row";
      row.onclick = () => openDetail(issue.id);
      row.innerHTML = `
        <div class="issue-text">${issue.shortIssue}</div>
        <div class="issue-status-icon ${statusToClass(issue.status)}">
          ${statusToSymbol(issue.status)}
        </div>
      `;
      group.appendChild(row);
    });

    issueListEl.appendChild(group);
  });
}

/* 6) Detail modal (status, photos, comments) */
const detailBackdrop = document.getElementById("detailBackdrop");
const detailShortIssue = document.getElementById("detailShortIssue");
const detailCategory = document.getElementById("detailCategory");
const detailFullIssue = document.getElementById("detailFullIssue");
const btnCompliant = document.getElementById("btnCompliant");
const btnNeedsAttention = document.getElementById("btnNeedsAttention");
const btnNA = document.getElementById("btnNA");
const photoInput = document.getElementById("photoInput");
const photoPreviewContainer = document.getElementById("photoPreviewContainer");
const commentInput = document.getElementById("commentInput");
const btnCancel = document.getElementById("btnCancel");
const btnSave = document.getElementById("btnSave");

let tempStatus = null;
let tempPhotos = [];
let tempComments = "";

function openDetail(id) {
  currentIssueId = id;
  const issue = issues.find(i => i.id === id);
  if (!issue) return;

  detailShortIssue.textContent = issue.shortIssue;
  detailCategory.textContent = issue.category;
  detailFullIssue.textContent = issue.fullIssue;

  tempStatus = issue.status;
  tempPhotos = Array.isArray(issue.photos) ? [...issue.photos] : [];
  tempComments = issue.comments || "";

  commentInput.value = tempComments;
  setStatusButtons(tempStatus);
  renderPhotoPreviews();

  photoInput.value = "";
  detailBackdrop.classList.add("open");
}
function closeDetail() {
  detailBackdrop.classList.remove("open");
  currentIssueId = null;
}
btnCancel.onclick = closeDetail;

function setStatusButtons(s) {
  [btnCompliant, btnNeedsAttention, btnNA].forEach(b => b.classList.remove("active"));
  if (s === "compliant") btnCompliant.classList.add("active");
  if (s === "needs_attention") btnNeedsAttention.classList.add("active");
  if (s === "na") btnNA.classList.add("active");
}
btnCompliant.onclick = () => { tempStatus = "compliant"; setStatusButtons(tempStatus); };
btnNeedsAttention.onclick = () => { tempStatus = "needs_attention"; setStatusButtons(tempStatus); };
btnNA.onclick = () => { tempStatus = "na"; setStatusButtons(tempStatus); };

function renderPhotoPreviews() {
  photoPreviewContainer.innerHTML = "";
  tempPhotos.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.className = "photo-thumb";
    photoPreviewContainer.appendChild(img);
  });
}

photoInput.onchange = e => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = evt => {
      tempPhotos.push(evt.target.result);
      renderPhotoPreviews();
    };
    reader.readAsDataURL(file);
  });
};

commentInput.oninput = e => {
  tempComments = e.target.value;
};

btnSave.onclick = () => {
  const idx = issues.findIndex(i => i.id === currentIssueId);
  if (idx === -1) return;
  issues[idx].status = tempStatus;
  issues[idx].photos = tempPhotos;
  issues[idx].comments = tempComments;
  saveIssues();
  renderIssueList();
  closeDetail();
};

detailBackdrop.onclick = e => {
  if (e.target === detailBackdrop) closeDetail();
};

/* 7) Submit to Google Sheet (with inspector info) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbznXNi6HRD8qpn3whwdxsj9X0dq7xdii-Gn7pPqzsNvnGoJQ1G5ephp1yhUlnqd-qW1/exec";

const inspectorNameInput = document.getElementById("inspectorName");
const inspectorEmailInput = document.getElementById("inspectorEmail");
const submitBtn = document.getElementById("submitBtn");

async function submitInspection() {
  const name = inspectorNameInput.value.trim();
  const email = inspectorEmailInput.value.trim();

  if (!name || !email) {
    alert("Please enter your name and email before submitting.");
    return;
  }

  const itemsToSend = issues.filter(i => i.status);
  if (!itemsToSend.length) {
    alert("No items have a status yet.");
    return;
  }

  const payload = {
    inspectorName: name,
    inspectorEmail: email,
    items: itemsToSend
  };

  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload)   // no custom headers → avoids CORS preflight issues
    });

    const text = await res.text();
    console.log("Script raw response:", text);

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error("Could not parse Apps Script response as JSON");
    }

    if (!res.ok || !data || data.result !== "success") {
      throw new Error("Apps Script error: " + (data && data.message ? data.message : "Unknown"));
    }

    console.log("Rows appended:", data.rowsAppended);

    // ✅ ONLY NOW reset everything
    alert("Inspection submitted! Starting a new blank inspection...");

    issues.forEach(i => {
      i.status = null;
      i.photos = [];
      i.comments = "";
    });

    inspectorNameInput.value = "";
    inspectorEmailInput.value = "";

    saveIssues();
    currentFilter = "All";
    renderFilters();
    renderIssueList();

  } catch (err) {
    console.error("Submission failed:", err);
    alert("Error submitting inspection. See console for details.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";
  }
}
submitBtn.onclick = submitInspection;

/* 8) Initial render */
renderFilters();
renderIssueList();
</script>
</body>
</html>
