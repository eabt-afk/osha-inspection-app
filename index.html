<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OSHA Self-Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
      padding: 0.75rem;
    }

    .app-shell {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }

    header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    header small {
      font-size: 0.75rem;
      color: #666;
    }

    .filters {
      display: flex;
      overflow-x: auto;
      padding: 0.5rem 0.5rem 0.5rem 1rem;
      gap: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .filter-chip {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      white-space: nowrap;
    }

    .filter-chip.active {
      background: #0070f3;
      color: #fff;
      border-color: #0070f3;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0.5rem 0.75rem 1rem;
    }

    .category-group {
      margin-bottom: 0.75rem;
    }

    .category-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
    }

    .issue-row {
      background: #fafafa;
      border-radius: 8px;
      padding: 0.5rem 0.5rem;
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      cursor: pointer;
    }

    .issue-text {
      font-size: 0.85rem;
      line-height: 1.3;
      flex: 1;
    }

    .issue-status-icon {
      font-size: 1.1rem;
      min-width: 1.6rem;
      text-align: right;
    }

    .status-compliant {
      color: #16a34a; /* green */
    }

    .status-needs_attention {
      color: #dc2626; /* red */
    }

    .status-na {
      color: #6b7280; /* gray */
    }

    /* Detail panel */
    .detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 10;
    }

    .detail-backdrop.open {
      display: flex;
    }

    .detail-panel {
      background: #fff;
      width: 100%;
      max-width: 600px;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
      padding: 1rem 1rem 1.25rem;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .detail-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      white-space: nowrap;
    }

    .detail-full-issue {
      font-size: 0.85rem;
      line-height: 1.4;
      background: #f9fafb;
      border-radius: 8px;
      padding: 0.5rem 0.6rem;
    }

    .status-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .status-label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-buttons {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .status-btn {
      flex: 1;
      min-width: 5rem;
      border-radius: 999px;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .status-btn.active {
      border-color: #0070f3;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
    }

    .photo-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .photo-label {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .photo-preview {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 0.25rem;
      display: none;
    }

    .photo-preview.visible {
      display: block;
    }

    .detail-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn {
      font-size: 0.8rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-primary {
      background: #0070f3;
      color: #fff;
    }

    @media (min-width: 700px) {
      .app-shell {
        height: 85vh;
      }
      .detail-panel {
        border-radius: 16px;
        margin-bottom: 2rem;
      }
      .detail-backdrop {
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>OSHA Self-Inspection</h1>
        <small>Tap an item to update status & add photos</small>
      </div>
    </header>

    <div class="filters" id="filters"></div>

    <div class="list" id="issueList"></div>
  </div>

  <!-- Detail / Form Panel -->
  <div class="detail-backdrop" id="detailBackdrop">
    <div class="detail-panel">
      <div class="detail-header">
        <div class="detail-title" id="detailShortIssue"></div>
        <span class="badge" id="detailCategory"></span>
      </div>
      <div class="detail-full-issue" id="detailFullIssue"></div>

      <div class="status-group">
        <div class="status-label">Status</div>
        <div class="status-buttons">
          <button class="status-btn" data-status="compliant" id="btnCompliant">✔ Compliant</button>
          <button class="status-btn" data-status="needs_attention" id="btnNeedsAttention">❌ Needs attention</button>
          <button class="status-btn" data-status="na" id="btnNA">➖ N/A</button>
        </div>
      </div>

      <div class="photo-group">
        <div class="photo-label">Photo (optional)</div>
        <input type="file" id="photoInput" accept="image/*" />
        <img id="photoPreview" class="photo-preview" alt="Issue photo preview" />
      </div>

      <div class="detail-actions">
        <button class="btn btn-secondary" id="btnCancel">Cancel</button>
        <button class="btn btn-primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    /****************************
     * 1. INITIAL DATA (sample)
     * Replace `initialIssues` with CSV→JSON converted list.
     ****************************/
    const initialIssues = [
      {
        id: 1,
        category: "PPE",
        shortIssue: "Eye protection available",
        fullIssue: "Eye protection must be available and worn at all times in designated eye protection areas.",
        status: null,
        photoDataUrl: ""
      },
      {
        id: 2,
        category: "PPE",
        shortIssue: "Gloves stored properly",
        fullIssue: "Gloves must be stored in a clean, dry location away from contaminants and not placed on the floor.",
        status: null,
        photoDataUrl: ""
      },
      {
        id: 3,
        category: "Electrical",
        shortIssue: "Panels accessible",
        fullIssue: "Electrical panels must remain unobstructed with at least 3 feet of clearance in front at all times.",
        status: null,
        photoDataUrl: ""
      }
      // Add your real items here...
    ];

    const STORAGE_KEY = "osha_inspection_issues_v1";

    function loadIssues() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // merge structure in case you add new issues later
          return initialIssues.map(base => {
            const found = parsed.find(p => p.id === base.id);
            return found ? found : base;
          });
        } catch (e) {
          console.warn("Failed to parse saved issues, using defaults.", e);
        }
      }
      return initialIssues;
    }

    function saveIssues() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(issues));
    }

    let issues = loadIssues();
    let currentIssueId = null;
    let currentFilter = "All";

    /****************************
     * 2. RENDER FILTER CHIPS
     ****************************/
    const filtersContainer = document.getElementById("filters");

    function getCategories() {
      const set = new Set(issues.map(i => i.category));
      return ["All", ...Array.from(set)];
    }

    function renderFilters() {
      filtersContainer.innerHTML = "";
      const cats = getCategories();
      cats.forEach(cat => {
        const chip = document.createElement("button");
        chip.className = "filter-chip" + (cat === currentFilter ? " active" : "");
        chip.textContent = cat;
        chip.addEventListener("click", () => {
          currentFilter = cat;
          renderFilters();
          renderIssueList();
        });
        filtersContainer.appendChild(chip);
      });
    }

    /****************************
     * 3. RENDER ISSUE LIST
     ****************************/
    const issueListEl = document.getElementById("issueList");

    function statusToIconClass(status) {
      if (status === "compliant") return "status-compliant";
      if (status === "needs_attention") return "status-needs_attention";
      if (status === "na") return "status-na";
      return "";
    }

    function statusToSymbol(status) {
      if (status === "compliant") return "✔";
      if (status === "needs_attention") return "✖";
      if (status === "na") return "➖";
      return "•";
    }

    function renderIssueList() {
      issueListEl.innerHTML = "";

      // filter
      let filtered = issues;
      if (currentFilter !== "All") {
        filtered = issues.filter(i => i.category === currentFilter);
      }

      // group by category
      const byCat = {};
      filtered.forEach(issue => {
        byCat[issue.category] = byCat[issue.category] || [];
        byCat[issue.category].push(issue);
      });

      Object.keys(byCat).sort().forEach(cat => {
        const group = document.createElement("div");
        group.className = "category-group";

        const title = document.createElement("div");
        title.className = "category-title";
        title.textContent = cat;
        group.appendChild(title);

        byCat[cat].forEach(issue => {
          const row = document.createElement("div");
          row.className = "issue-row";

          const txt = document.createElement("div");
          txt.className = "issue-text";
          txt.textContent = issue.shortIssue;
          row.appendChild(txt);

          const icon = document.createElement("div");
          icon.className = "issue-status-icon " + statusToIconClass(issue.status);
          icon.textContent = statusToSymbol(issue.status);
          row.appendChild(icon);

          row.addEventListener("click", () => openDetail(issue.id));
          group.appendChild(row);
        });

        issueListEl.appendChild(group);
      });
    }

    /****************************
     * 4. DETAIL / FORM LOGIC
     ****************************/
    const detailBackdrop = document.getElementById("detailBackdrop");
    const detailShortIssue = document.getElementById("detailShortIssue");
    const detailCategory = document.getElementById("detailCategory");
    const detailFullIssue = document.getElementById("detailFullIssue");
    const btnCompliant = document.getElementById("btnCompliant");
    const btnNeedsAttention = document.getElementById("btnNeedsAttention");
    const btnNA = document.getElementById("btnNA");
    const photoInput = document.getElementById("photoInput");
    const photoPreview = document.getElementById("photoPreview");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");

    let tempStatus = null;
    let tempPhotoDataUrl = "";

    function setStatusButtons(status) {
      [btnCompliant, btnNeedsAttention, btnNA].forEach(btn => {
        btn.classList.remove("active");
      });
      if (status === "compliant") btnCompliant.classList.add("active");
      if (status === "needs_attention") btnNeedsAttention.classList.add("active");
      if (status === "na") btnNA.classList.add("active");
    }

    function openDetail(id) {
      currentIssueId = id;
      const issue = issues.find(i => i.id === id);
      if (!issue) return;

      // populate UI
      detailShortIssue.textContent = issue.shortIssue;
      detailCategory.textContent = issue.category;
      detailFullIssue.textContent = issue.fullIssue;

      tempStatus = issue.status || null;
      tempPhotoDataUrl = issue.photoDataUrl || "";

      setStatusButtons(tempStatus);

      if (tempPhotoDataUrl) {
        photoPreview.src = tempPhotoDataUrl;
        photoPreview.classList.add("visible");
      } else {
        photoPreview.src = "";
        photoPreview.classList.remove("visible");
      }
      photoInput.value = "";

      detailBackdrop.classList.add("open");
    }

    function closeDetail() {
      currentIssueId = null;
      detailBackdrop.classList.remove("open");
    }

    // Status button handlers
    btnCompliant.addEventListener("click", () => {
      tempStatus = "compliant";
      setStatusButtons(tempStatus);
    });
    btnNeedsAttention.addEventListener("click", () => {
      tempStatus = "needs_attention";
      setStatusButtons(tempStatus);
    });
    btnNA.addEventListener("click", () => {
      tempStatus = "na";
      setStatusButtons(tempStatus);
    });

    // Photo upload handler
    photoInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        tempPhotoDataUrl = evt.target.result;
        photoPreview.src = tempPhotoDataUrl;
        photoPreview.classList.add("visible");
      };
      reader.readAsDataURL(file);
    });

    // Cancel / Save
    btnCancel.addEventListener("click", closeDetail);

    btnSave.addEventListener("click", () => {
      if (!currentIssueId) return;
      const idx = issues.findIndex(i => i.id === currentIssueId);
      if (idx === -1) return;

      issues[idx].status = tempStatus;
      issues[idx].photoDataUrl = tempPhotoDataUrl;

      saveIssues();
      renderIssueList();
      closeDetail();
    });

    // Close on backdrop click
    detailBackdrop.addEventListener("click", e => {
      if (e.target === detailBackdrop) {
        closeDetail();
      }
    });

    /****************************
     * 5. INITIAL RENDER
     ****************************/
    renderFilters();
    renderIssueList();
  </script>
</body>
</html>
